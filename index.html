<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Identity Resolution & Default Aggregation â€” Interactive Graph</title>
  <style>
    :root {
      --bg: #0f172a;           
      --panel: #111827;        
      --muted: #94a3b8;        
      --text: #e5e7eb;         
      --accent: #38bdf8;       
      --brandA: #22c55e;       
      --brandB: #f97316;       
      --dupJur: #a78bfa;       
      --dupBrand: #f43f5e;     
      --orphan: #eab308;       
      --link: #334155;         
    }
    html, body {
      margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    header {
      padding: .75rem 1rem;
      display:flex; gap: .75rem; align-items: center; flex-wrap: wrap;
      border-bottom: 1px solid #1f2937;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0));
    }
    header h1 { font-size: 1rem; margin: 0; font-weight: 600; }
    .controls { display:flex; gap:.5rem; flex-wrap: wrap; align-items:center; }
    .control {
      background: var(--panel); color: var(--text); border: 1px solid #1f2937;
      border-radius: .75rem; padding: .4rem .6rem; font-size:.85rem; display:flex; gap:.4rem; align-items:center;
    }
    .control input[type="checkbox"] { width: 1rem; height: 1rem; }
    .btn {
      border: 1px solid #1f2937; background: #0b1220; color: var(--text);
      padding: .45rem .7rem; border-radius: .75rem; font-size:.85rem;
    }
    .legend { display:flex; gap:.5rem; flex-wrap: wrap; align-items:center; }
    .key { display:inline-flex; gap:.35rem; align-items:center; padding:.2rem .5rem; border-radius:.5rem; background:#0b1220; border:1px solid #1f2937; }
    .swatch { width: 12px; height: 12px; border-radius:50%; display:inline-block; }
    .panel { display:grid; grid-template-columns: 1fr; height: 100%; }
    svg { width: 100%; height: 100%; touch-action: none; }
    .link { stroke: var(--link); stroke-opacity:.6; }
    .dup-link { stroke-dasharray: 4 3; stroke-width: 1.5px; pointer-events: none; }
    .node circle { stroke: #0b1220; stroke-width: 1px; }
    .node text {
      fill: var(--text); font-size: .8rem; text-anchor: middle;
      pointer-events: none; paint-order: stroke;
      stroke: #0b1220; stroke-width: 3px; stroke-linejoin: round;
    }
    .badge {
      position: fixed; right: .75rem; bottom: .75rem; font-size: .8rem;
      background:#0b1220;border:1px solid #1f2937;border-radius:.6rem;padding:.35rem .6rem;color:var(--muted);
    }
    .tooltip {
      position: fixed; pointer-events: none; background:#0b1220; color:var(--text);
      border:1px solid #1f2937; border-radius:.6rem; padding:.5rem .6rem; font-size:.85rem; max-width: 22rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    footer { padding:.5rem 1rem; color:var(--muted); font-size:.8rem; border-top: 1px solid #1f2937; }
    @media (max-width: 600px){ .node text { font-size: .7rem; } }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Identity Resolution & Default Aggregation</h1>
    <div class="controls">
      <label class="control"><input id="toggle-dup-jur" type="checkbox" checked /> Cross-jurisdiction</label>
      <label class="control"><input id="toggle-dup-brand" type="checkbox" checked /> Cross-brand</label>
      <label class="control"><input id="toggle-orphan" type="checkbox" checked /> Orphans</label>
      <button id="expand-all" class="btn">Expand</button>
      <button id="collapse-all" class="btn">Collapse</button>
      <button id="reset" class="btn">Reset view</button>
    </div>
  </header>
  <div class="panel">
    <svg id="viz" role="img"></svg>
    <div id="tooltip" class="tooltip" style="opacity:0"></div>
  </div>
  <footer>Drag nodes. Tap to collapse/expand. Pinch/scroll to zoom. Dashed links = duplicates.</footer>
</div>
<div class="badge">Mobile-friendly</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
// ------- Sample hierarchical data -------
// Group -> Brands -> Jurisdictions -> Profiles -> Accounts
const data = {
  name: "Group",
  type: "group",
  children: [
    {
      name: "Brand A",
      type: "brand",
      brand: "A",
      children: [
        {
          name: "Ireland",
          type: "jurisdiction",
          jurisdiction: "IE",
          children: [
            profile("C-1001", {brand:"A", jurisdiction:"IE", orphan:false, dup_same_brand_cross_jur:true, dup_cross_brand:false},
              [acct(8200, "A", "performing", 0), acct(1200, "BBB", "performing", 12)]),
            profile("C-1002", {brand:"A", jurisdiction:"IE", orphan:true},
              [acct(450, "B", "default", 120)]),
            profile("C-1003", {brand:"A", jurisdiction:"IE", dup_cross_brand:true},
              [acct(3000, "A", "performing", 0)])
          ]
        },
        {
          name: "UK",
          type: "jurisdiction",
          jurisdiction: "UK",
          children: [
            profile("C-1001-dup", {brand:"A", jurisdiction:"UK", dup_same_brand_cross_jur:true, canonical:"C-1001"},
              [acct(2600, "BBB", "performing", 5)]),
            profile("C-1100", {brand:"A", jurisdiction:"UK"},
              [acct(900, "CCC", "performing", 18)])
          ]
        },
        {
          name: "Spain",
          type: "jurisdiction",
          jurisdiction: "ES",
          children: [
            profile("C-1200", {brand:"A", jurisdiction:"ES"},
              [acct(1500, "A", "performing", 0)]),
            profile("C-1300", {brand:"A", jurisdiction:"ES", orphan:true},
              [acct(300, "B", "default", 95)])
          ]
        }
      ]
    },
    {
      name: "Brand B",
      type: "brand",
      brand: "B",
      children: [
        {
          name: "Ireland",
          type: "jurisdiction",
          jurisdiction: "IE",
          children: [
            profile("C-1003-dup", {brand:"B", jurisdiction:"IE", dup_cross_brand:true, canonical:"C-1003"},
              [acct(7000, "A", "performing", 0)]),
            profile("C-2000", {brand:"B", jurisdiction:"IE", orphan:true},
              [acct(120, "CCC", "default", 180)])
          ]
        }
      ]
    }
  ]
};

function acct(balance, creditGrade, status, dpd){
  return { name: "Acct " + Math.random().toString(36).slice(2,6).toUpperCase(),
    type:"account", balance, creditGrade, defaultStatus:status, dpd };
}
function profile(id, flags, accounts){
  return { name:id, id, type:"profile", orphan:false, dup_same_brand_cross_jur:false, dup_cross_brand:false,
    ...flags, children:accounts };
}

// Duplicate relationships
const dupLinks = [
  { sourceId: "C-1001", targetId: "C-1001-dup", type: "cross-jurisdiction" },
  { sourceId: "C-1003", targetId: "C-1003-dup", type: "cross-brand" }
];

// Compute balances
function computeCumulativeBalance(node){
  if(node.type === "account"){ node.cumBalance = node.balance; return node.balance; }
  let sum = 0; (node.children||[]).forEach(c => sum+=computeCumulativeBalance(c));
  node.cumBalance = sum; return sum;
}
computeCumulativeBalance(data);

// collapse helper
function collapseAll(d){ if(d.children){ d._children=d.children; d.children.forEach(collapseAll); d.children=null; } }
function expandAll(d){ if(d._children){ d.children=d._children; d._children=null; } (d.children||[]).forEach(expandAll); }
data.children.forEach(b => b.children.forEach(j => collapseAll(j))); // collapse jurisdictions initially

// flatten visible tree
let nodeIdCounter=0;
function flattenVisible(root){
  const nodes=[], links=[];
  function recurse(d, parent){
    d.uid=++nodeIdCounter; nodes.push(d);
    (d.children||[]).forEach(c => { links.push({source:d,target:c,type:"hier"}); recurse(c,d); });
  }
  recurse(root); return {nodes,links};
}
let {nodes,links}=flattenVisible(data);

// radius scale
const radiusScale = d3.scaleSqrt().domain([1,data.cumBalance]).range([6,42]);

// color function
function nodeColor(d){
  if(d.type==="brand") return d.brand==="A"?"var(--brandA)":"var(--brandB)";
  if(d.type==="jurisdiction") return "#60a5fa";
  if(d.type==="profile"){
    if(d.dup_cross_brand) return "var(--dupBrand)";
    if(d.dup_same_brand_cross_jur) return "var(--dupJur)";
    if(d.orphan) return "var(--orphan)";
    return "#38bdf8";
  }
  if(d.type==="account") return d.defaultStatus==="default"?"#ef4444":"#22d3ee";
  return "var(--accent)";
}

// setup svg
const svg=d3.select("#viz"), g=svg.append("g");
const linkGroup=g.append("g"), dupGroup=g.append("g"), nodeGroup=g.append("g");
const tooltip=d3.select("#tooltip");
const width=window.innerWidth, height=window.innerHeight;

const sim=d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d=>d.uid).distance(d=>50+(radiusScale(d.target.cumBalance)||10)).strength(.12))
  .force("charge", d3.forceManyBody().strength(-120))
  .force("collide", d3.forceCollide().radius(d=>(radiusScale(d.cumBalance)||8)+6).iterations(2))
  .force("center", d3.forceCenter(width/2,height/2));

// zoom
svg.call(d3.zoom().scaleExtent([0.35,2.5]).on("zoom",ev=>g.attr("transform",ev.transform)));

// render
function render(){
  const link=linkGroup.selectAll("line").data(links,d=>d.source.uid+"-"+d.target.uid);
  link.enter().append("line").attr("class","link").merge(link);
  link.exit().remove();

  const idmap=new Map(nodes.filter(n=>n.type==="profile").map(n=>[n.name,n]));
  const showJur=document.getElementById("toggle-dup-jur").checked;
  const showBrand=document.getElementById("toggle-dup-brand").checked;
  const visibleDup=dupLinks.map(l=>({...l,source:idmap.get(l.sourceId),target:idmap.get(l.targetId)}))
    .filter(l=>l.source&&l.target)
    .filter(l=>(l.type==="cross-jurisdiction"&&showJur)||(l.type==="cross-brand"&&showBrand));
  const dup=dupGroup.selectAll("path").data(visibleDup,d=>d.source.uid+"~"+d.target.uid);
  dup.enter().append("path").attr("class","dup-link").attr("fill","none")
    .attr("stroke",d=>d.type==="cross-jurisdiction"?"var(--dupJur)":"var(--dupBrand)").merge(dup);
  dup.exit().remove();

  const node=nodeGroup.selectAll("g.node").data(nodes,d=>d.uid);
  const nodeEnter=node.enter().append("g").attr("class","node")
    .call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended))
    .on("click",(ev,d)=>{toggle(d); ev.stopPropagation();})
    .on("mouseenter",(ev,d)=>showTooltip(ev,d))
    .on("mousemove",(ev,d)=>moveTooltip(ev))
    .on("mouseleave",hideTooltip);
  nodeEnter.append("circle").attr("r",d=>Math.max(6,radiusScale(d.cumBalance)||6)).attr("fill",d=>nodeColor(d));
  nodeEnter.append("text").attr("dy",d=>(radiusScale(d.cumBalance)||8)+12).text(d=>labelFor(d));
  node.exit().remove();

  sim.nodes(nodes).on("tick",()=>{
    linkGroup.selectAll("line").attr("x1",d=>d.source.x).attr("y1",d=>d.source.y)
      .attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
    dupGroup.selectAll("path").attr("d",d=>{
      const x1=d.source.x,y1=d.source.y,x2=d.target.x,y2=d.target.y;
      const dx=x2-x1,dy=y2-y1,dr=Math.hypot(dx,dy)*0.8;
      return `M${x1},${y1} A${dr},${dr} 0 0,1 ${x2},${y2}`;
    });
    nodeGroup.selectAll("g.node").attr("transform",d=>`translate(${d.x},${d.y})`);
  });
  sim.force("link").links(links);
  sim.alpha(0.9).restart();
}

function labelFor(d){
  if(d.type==="group") return "Group";
  if(d.type==="brand") return "Brand "+d.brand;
  if(d.type==="jurisdiction") return d.name;
  if(d.type==="profile"){
    let tags=[]; if(d.dup_cross_brand)tags.push("xBrand"); if(d.dup_same_brand_cross_jur)tags.push("xJur"); if(d.orphan)tags.push("Orphan");
    return d.name+(tags.length?" Â· "+tags.join(","):"");
  }
  if(d.type==="account") return (d.defaultStatus==="default"?"âš ":"âœ“")+" â‚¬"+d.balance;
  return d.name;
}

function toggle(d){ if(d.children){ d._children=d.children; d.children=null; }
  else if(d._children){ d.children=d._children; d._children=null; }
  const f=flattenVisible(data); nodes=f.nodes; links=f.links; render(); }

function dragstarted(ev,d){ if(!ev.active) sim.alphaTarget(.3).restart(); d.fx=d.x; d.fy=d.y; }
function dragged(ev,d){ d.fx=ev.x; d.fy=ev.y; }
function dragended(ev,d){ if(!ev.active) sim.alphaTarget(0); }

function showTooltip(ev,d){
  let html=`<b>${labelFor(d)}</b><br><b>Type:</b> ${d.type}`;
  if(d.type!=="account") html+=`<br><b>Cumulative Balance:</b> â‚¬${d.cumBalance}`;
  if(d.type==="profile"){
    if(d.orphan) html+="<br>Orphan: Yes";
    if(d.dup_cross_brand) html+="<br>Cross-Brand Duplicate";
    if(d.dup_same_brand_cross_jur) html+="<br>Cross-Jurisdiction Duplicate";
  }
  if(d.type==="account"){
    html+=`<br>Credit Grade: ${d.creditGrade}`;
    html+=`<br>Status: ${d.defaultStatus}`;
    html+=`<br>Days Past Due: ${d.dpd}`;
  }
  tooltip.style("opacity",1).html(html);
  moveTooltip(ev);
}
function moveTooltip(ev){ const pad=12; const bbox=tooltip.node().getBoundingClientRect();
  let x=ev.clientX+pad,y=ev.clientY+pad;
  if(x+bbox.width>window.innerWidth) x=ev.clientX-bbox.width-pad;
  if(y+bbox.height>window.innerHeight) y=ev.clientY-bbox.height-pad;
  tooltip.style("left",x+"px").style("top",y+"px"); }
function hideTooltip(){ tooltip.style("opacity",0); }

document.getElementById("expand-all").onclick=()=>{expandAll(data); const f=flattenVisible(data); nodes=f.nodes; links=f.links; render();};
document.getElementById("collapse-all").onclick=()=>{data.children.forEach(b=>b.children.forEach(j=>collapseAll(j))); const f=flattenVisible(data); nodes=f.nodes; links=f.links; render();};
document.getElementById("reset").onclick=()=>{svg.transition().duration(400).call(d3.zoom().transform,d3.zoomIdentity);};
document.getElementById("toggle-dup-jur").onchange=render;
document.getElementById("toggle-dup-brand").onchange=render;
document.getElementById("toggle-orphan").onchange=render;

// initial render
render();
</script>
</body>
</html>
