<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Michael Bloggs — Collapsible Identity Tree</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --grid:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#38bdf8; --brandA:#22c55e; --brandB:#f97316; --dup:#a78bfa;
    --ok:#22d3ee; --def:#ef4444;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:grid;grid-template-rows:auto 1fr auto;height:100%}
  header{
    display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;
    padding:.8rem 1rem;border-bottom:1px solid var(--grid);
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(0,0,0,0))
  }
  header h1{font-size:1rem;margin:0;font-weight:600;letter-spacing:.2px}
  .controls{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .control,.btn{
    background:var(--panel);border:1px solid var(--grid);border-radius:.7rem;
    padding:.45rem .7rem;font-size:.85rem;color:var(--text)
  }
  .legend{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .key{display:inline-flex;gap:.35rem;align-items:center;padding:.2rem .5rem;
    border-radius:.5rem;background:var(--panel);border:1px solid var(--grid)}
  .swatch{width:12px;height:12px;border-radius:50%}
  .panel{position:relative;isolation:isolate}
  svg{width:100%;height:100%;display:block}
  .link{fill:none;stroke:#334155;stroke-opacity:.6;stroke-width:1.5px}
  .dup-link{fill:none;stroke:var(--dup);stroke-width:2px;stroke-dasharray:4 3;pointer-events:none}
  .node circle{fill:#0e1729;stroke:#0b1220;stroke-width:1px}
  .node-label{
    font-size:.86rem; fill:var(--text); dominant-baseline:middle;
    paint-order:stroke; stroke:#0b1220; stroke-width:3px; stroke-linejoin:round
  }
  .badge{position:fixed;right:.75rem;bottom:.75rem;font-size:.8rem;
    background:var(--panel);border:1px solid var(--grid);border-radius:.6rem;padding:.35rem .6rem;color:var(--muted)}
  .tooltip{
    position:fixed;pointer-events:none;background:var(--panel);color:var(--text);
    border:1px solid var(--grid);border-radius:.6rem;padding:.55rem .65rem;font-size:.85rem;
    max-width:24rem;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0
  }
  footer{padding:.6rem 1rem;color:var(--muted);font-size:.8rem;border-top:1px solid var(--grid)}
  @media (max-width:640px){ .node-label{font-size:.8rem} }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Identity Resolution — Michael Bloggs (Collapsible Tree)</h1>
    <div class="controls">
      <label class="control"><input id="toggle-dup" type="checkbox" checked /> Show inferred silo links</label>
      <button id="expand" class="btn">Expand all</button>
      <button id="collapse" class="btn">Collapse all</button>
      <button id="reset" class="btn">Reset view</button>
    </div>
    <div class="legend">
      <span class="key"><i class="swatch" style="background:var(--accent)"></i>Master</span>
      <span class="key"><i class="swatch" style="background:var(--brandA)"></i>Brand A</span>
      <span class="key"><i class="swatch" style="background:var(--brandB)"></i>Brand B</span>
      <span class="key"><i class="swatch" style="background:var(--ok)"></i>Performing acct</span>
      <span class="key"><i class="swatch" style="background:var(--def)"></i>Defaulted acct</span>
      <span class="key"><i class="swatch" style="background:var(--dup)"></i>Inferred silo↔silo</span>
    </div>
  </header>

  <div class="panel">
    <svg id="viz" role="img" aria-label="Collapsible identity tree for Michael Bloggs">
      <defs>
        <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="4" result="glow"/>
          <feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
    </svg>
    <div id="tooltip" class="tooltip"></div>
  </div>

  <footer>Tap labels to expand/collapse. Root on the left. Node size ≈ cumulative balance. Dashed arcs show inferred duplicates between silo profiles.</footer>
</div>
<div class="badge">Mobile-friendly</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
/* ------------------ Data (one customer across silos) ------------------ */
function acct(id, balance, grade, status, dpd){
  return { name:id, type:"account", balance, creditGrade:grade, defaultStatus:status, dpd };
}
function profile(label, meta, accounts){
  return { name:label, type:"profile", ...meta, children:accounts };
}
const data = {
  name:"MASTER: Michael Bloggs (MCID-0001)", type:"master",
  attributes:{ name:"Michael Bloggs", address:"12 Oak Road, Dublin, D14",
    mobile:"+353 87 123 4567", landline:"+353 1 234 5678", pps:"1234567A" },
  children:[
    { name:"Brand A", type:"brand", brand:"A", children:[
      { name:"ROI", type:"jurisdiction", jurisdiction:"ROI", children:[
        profile("A-ROI-Michael Bloggs",
          {brand:"A", jurisdiction:"ROI", attributes:{
            name:"Michael Bloggs", address:"12 Oak Road, Dublin 14",
            mobile:"+353871234567", landline:"+35312345678", pps:"1234567A"}},
          [acct("Acct A-ROI-001",8200,"A","performing",0),
           acct("Acct A-ROI-002",1200,"BBB","performing",12)])
      ]},
      { name:"NI", type:"jurisdiction", jurisdiction:"NI", children:[
        profile("A-NI-M Bloggs",
          {brand:"A", jurisdiction:"NI", attributes:{
            name:"M. Bloggs", address:"12 Oak Rd, Belfast BT1",
            mobile:"+44 7700 900123", landline:null, pps:null}},
          [acct("Acct A-NI-001",2600,"BBB","performing",5)])
      ]},
      { name:"GB", type:"jurisdiction", jurisdiction:"GB", children:[
        profile("A-GB-Mike Bloggs",
          {brand:"A", jurisdiction:"GB", attributes:{
            name:"Mike Bloggs", address:"12 Oak Road, London",
            mobile:null, landline:"+44 20 7946 0000", pps:null}},
          [acct("Acct A-GB-001",1500,"A","performing",0)])
      ]}
    ]},
    { name:"Brand B", type:"brand", brand:"B", children:[
      { name:"ROI", type:"jurisdiction", jurisdiction:"ROI", children:[
        profile("B-ROI-Michael J Bloggs",
          {brand:"B", jurisdiction:"ROI", attributes:{
            name:"Michael J Bloggs", address:"12 Oak Rd, D14",
            mobile:"+353 (87) 123-4567", landline:null, pps:null}},
          [acct("Acct B-ROI-001",7000,"A","performing",0),
           acct("Acct B-ROI-002",120,"CCC","default",180)])
      ]}
    ]}
  ]
};
// Inferred duplicate (silo↔silo) links by profile label (drawn as dashed arcs)
const inferred = [
  {s:"A-ROI-Michael Bloggs", t:"A-NI-M Bloggs"},
  {s:"A-ROI-Michael Bloggs", t:"A-GB-Mike Bloggs"},
  {s:"A-ROI-Michael Bloggs", t:"B-ROI-Michael J Bloggs"},
  {s:"A-NI-M Bloggs",       t:"A-GB-Mike Bloggs"}
];

/* ------------------ Balances & collapse helpers ------------------ */
function cumBalance(n){
  if(n.type==="account"){ n.cumBalance=n.balance; return n.cumBalance; }
  let s=0; (n.children||[]).forEach(c=>s+=cumBalance(c));
  n.cumBalance=s; return s;
}
cumBalance(data);

function collapseAll(hnode){
  if(hnode.children){
    hnode._children = hnode.children;
    hnode._children.forEach(collapseAll);
    hnode.children = null;
  }
}
function expandAll(hnode){
  if(hnode._children){ hnode.children = hnode._children; hnode._children = null; }
  (hnode.children||[]).forEach(expandAll);
}

/* ------------------ Build hierarchy ------------------ */
let root = d3.hierarchy(data);
root.each(d => { d._id = d.data.name; }); // stable key
root.x0 = 0; root.y0 = 0;

// Start with jurisdictions collapsed under brands for readability
(root.children||[]).forEach(b => (b.children||[]).forEach(j => collapseAll(j)));

/* ------------------ Layout + SVG groups ------------------ */
const svg = d3.select("#viz");
const gLinks = svg.append("g");
const gDup   = svg.append("g");
const gNodes = svg.append("g");
const tooltip = d3.select("#tooltip");

const dx = 56;          // vertical spacing
const dyBase = 180;     // base horizontal spacing
const tree = d3.tree().nodeSize([dx, dyBase]);

const diagonal = d3.linkHorizontal()
  .x(d => d.y)
  .y(d => d.x);

/* ------------------ Render/update ------------------ */
function update(source){
  // Layout
  tree(root);

  // Compute responsive viewBox bounds
  let left = Infinity, right = -Infinity, top = Infinity, bottom = -Infinity;
  root.each(d => {
    if (d.x < top) top = d.x;
    if (d.x > bottom) bottom = d.x;
    if (d.y < left) left = d.y;
    if (d.y > right) right = d.y;
  });
  const margin = {top: 40, right: 80, bottom: 40, left: 40};
  const width  = right - left + margin.left + margin.right;
  const height = bottom - top + margin.top + margin.bottom;
  svg.attr("viewBox", [left - margin.left, top - margin.top, width, height].join(" "));

  // LINKS
  const link = gLinks.selectAll("path.link")
    .data(root.links(), d => d.target.data.name);

  link.enter().append("path")
      .attr("class","link")
      .attr("d", d => {
        const o = {x: source.x0 ?? source.x, y: source.y0 ?? source.y};
        return diagonal({source: o, target: o});
      })
    .merge(link)
      .transition().duration(350)
      .attr("d", diagonal);

  link.exit().transition().duration(250)
      .attr("d", d => {
        const o = {x: source.x ?? 0, y: source.y ?? 0};
        return diagonal({source: o, target: o});
      })
      .remove();

  // NODES
  const nodes = root.descendants();
  const node = gNodes.selectAll("g.node")
    .data(nodes, d => d._id);

  const nodeEnter = node.enter().append("g")
      .attr("class","node")
      .attr("transform", d => `translate(${source.y0 ?? source.y},${source.x0 ?? source.x})`)
      .on("click", (ev,d)=>{ toggle(d); update(d); ev.stopPropagation(); })
      .on("pointerenter",(ev,d)=>showTooltip(ev,d))
      .on("pointermove",(ev)=>moveTooltip(ev))
      .on("pointerleave", hideTooltip);

  nodeEnter.append("circle")
    .attr("r", d => radiusFor(d))
    .attr("filter", d => d.depth===0 ? "url(#softGlow)" : null)
    .attr("fill", d => fillFor(d))
    .attr("stroke", "#0b1220");

  nodeEnter.append("text")
    .attr("class","node-label")
    .attr("x", d => (d.children||d._children) ? -10 : 10)
    .attr("text-anchor", d => (d.children||d._children) ? "end" : "start")
    .attr("dy", "0")
    .text(d => labelFor(d));

  const nodeUpdate = nodeEnter.merge(node);
  nodeUpdate.transition().duration(350)
    .attr("transform", d => `translate(${d.y},${d.x})`);

  node.exit().transition().duration(250)
    .attr("transform", d => `translate(${source.y ?? 0},${source.x ?? 0})`)
    .style("opacity",0).remove();

  // INFERRED CROSS-SILO (dashed) LINKS
  drawInferred(nodes);

  // Stash positions for next transition
  root.each(d => { d.x0 = d.x; d.y0 = d.y; });
}

// Toggle (hierarchy nodes, not raw data)
function toggle(d){
  if(d.children){ d._children = d.children; d.children = null; }
  else if(d._children){ d.children = d._children; d._children = null; }
}

/* ------------------ Node visuals ------------------ */
function radiusFor(d){
  if(d.data.type==="master") return 14;
  if(d.data.type==="account") return 6;
  // mild scaling by subtree balance for containers/profiles
  const c = cumulative(d);
  return Math.max(7, Math.min(16, 6 + Math.log10((c||1)+1)*6));
}
function cumulative(d){
  // cache on data for speed; recompute once at load (static example)
  if(d.data.cumBalance != null) return d.data.cumBalance;
  return 1;
}
function fillFor(d){
  const t = d.data.type;
  if(t==="master") return "var(--accent)";
  if(t==="brand")  return d.data.brand==="A" ? "var(--brandA)" : "var(--brandB)";
  if(t==="jurisdiction") return "#60a5fa";
  if(t==="profile") return d.data.brand==="A" ? "#34d399" : "#fb923c";
  if(t==="account") return d.data.defaultStatus==="default" ? "var(--def)" : "var(--ok)";
  return "var(--accent)";
}
function labelFor(d){
  const t=d.data.type;
  if(t==="master") return "MASTER: Michael Bloggs";
  if(t==="brand")  return `Brand ${d.data.brand}`;
  if(t==="jurisdiction") return d.data.name;
  if(t==="profile") return d.data.name;
  if(t==="account"){
    const v = new Intl.NumberFormat().format(d.data.balance||0);
    return `${d.data.defaultStatus==="default"?"⚠":"✓"} €${v}`;
  }
  return d.data.name;
}

/* ------------------ Tooltip ------------------ */
const tooltipEl = d3.select("#tooltip");
function showTooltip(ev,d){
  let html = `<b>${labelFor(d)}</b><br><b>Type:</b> ${d.data.type}`;
  if(d.data.type!=="account"){
    const val = new Intl.NumberFormat().format(d.data.cumBalance||0);
    html += `<br><b>Cumulative Balance:</b> €${val}`;
  }
  if(d.data.type==="master"){
    const a=d.data.attributes||{};
    html += `<br><br><b>Resolved Attributes</b>`;
    html += `<br>Name: ${a.name||"—"}`;
    html += `<br>Address: ${a.address||"—"}`;
    html += `<br>Mobile: ${a.mobile||"—"}`;
    html += `<br>Landline: ${a.landline||"—"}`;
    html += `<br>PPS: ${a.pps||"—"}`;
  }
  if(d.data.type==="profile"){
    const a=d.data.attributes||{};
    html += `<br><br><b>Captured Attributes</b>`;
    html += `<br>Name: ${a.name??"—"}`;
    html += `<br>Address: ${a.address??"—"}`;
    html += `<br>Mobile: ${a.mobile??"—"}`;
    html += `<br>Landline: ${a.landline??"—"}`;
    html += `<br>PPS: ${a.pps??"—"}`;
  }
  if(d.data.type==="account"){
    html += `<br><b>Credit Grade:</b> ${d.data.creditGrade}`;
    html += `<br><b>Status:</b> ${d.data.defaultStatus}`;
    html += `<br><b>Days Past Due:</b> ${d.data.dpd}`;
  }
  tooltipEl.html(html).style("opacity",1);
  moveTooltip(ev);
}
function moveTooltip(ev){
  const pad=12, vw=window.innerWidth, vh=window.innerHeight;
  const box=tooltipEl.node().getBoundingClientRect();
  let x=ev.clientX+pad, y=ev.clientY+pad;
  if(x+box.width>vw) x=ev.clientX-box.width-pad;
  if(y+box.height>vh) y=ev.clientY-box.height-pad;
  tooltipEl.style("left",x+"px").style("top",y+"px");
}
function hideTooltip(){ tooltipEl.style("opacity",0); }

/* ------------------ Inferred silo (dashed) links ------------------ */
function drawInferred(nodes){
  gDup.selectAll("*").remove();
  if(!document.getElementById("toggle-dup").checked) return;

  const index = new Map(nodes.filter(n=>n.data.type==="profile").map(n => [n.data.name, n]));
  inferred.forEach(({s,t})=>{
    const a=index.get(s), b=index.get(t);
    if(!a||!b) return;
    const pathD = d3.linkHorizontal().x(d=>d.y).y(d=>d.x)({
      source:{x:a.x, y:a.y},
      target:{x:b.x, y:b.y}
    });
    gDup.append("path").attr("class","dup-link").attr("d",pathD)
        .append("title").text("Inferred duplicate");
  });
}

/* ------------------ Controls ------------------ */
document.getElementById("expand").onclick = ()=>{ expandAll(root); update(root); };
document.getElementById("collapse").onclick= ()=>{
  (root.children||[]).forEach(b => (b.children||[]).forEach(j => collapseAll(j)));
  update(root);
};
document.getElementById("reset").onclick = ()=>{ update(root); };
document.getElementById("toggle-dup").onchange = ()=> update(root);

/* ------------------ First render ------------------ */
update(root);
window.addEventListener("resize", ()=> update(root));
</script>
</body>
</html>
